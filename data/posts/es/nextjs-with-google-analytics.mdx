---
author: Arturo Campos
title: Registrar y mostrar visitas con Next.js y Google Analytics
slug: nextjs-with-google-analytics
date: '2020-12-31T21:45:00-06:00'
description: C√≥mo configurar correctamente Google Analytics con Next.js y al mismo tiempo utilizarlo para mostrar el contador de visitas en cada p√°gina.
image: /images/blog/nextjs-with-google-analytics.png
---

_[Salte directamente a la soluci√≥n](#solution) y evite la charla de introducci√≥n.._

---

Cuando cre√© [inicialmente](https://github.com/arturocr/arturocampos.dev/commit/e19ff8598bf26ca0de166358628ac6ed367108db) este sitio web, decid√≠ usar algo diferente a Google Analytics para el seguimiento de mis visitantes.

En ese momento, decid√≠ usar la soluci√≥n [HappyKit Analytics](https://happykit.dev/solutions/analytics), sin embargo, no era realmente compatible con el enrutamiento internacionalizado de Next.js, ya que no estaba rastreando activamente algunas de las rutas din√°micas, aunque recomiendo encarecidamente echar un vistazo a ese producto. El desarrollador tiene algunas caracter√≠sticas nuevas en mente para el futuro.

Despu√©s de explorar algunas opciones, descubr√≠ [GoatCounter](https://www.goatcounter.com/) que result√≥ ser una soluci√≥n realmente agradable y centrada en la privacidad, I [decid√≠ probarla](https://github.com/arturocr/arturocampos.dev/commit/c63bff446667c65b988624cc11d733eb1e3d936e) e incluso [la us√© para mostrar las visitas por p√°gina](https://github.com/arturocr/arturocampos.dev/commit/ec827683398f6f17139a6fb41f6b6af87a4e0833) en las publicaciones de mi blog usando [su API](https://www.goatcounter.com/api).

Sin embargo, ten√≠a una inquietud, la ventana de retenci√≥n de datos es de solo 6 meses y, como quer√≠a usar el motor de an√°lisis como la √∫nica fuente de verdad para los contadores de visitas de p√°gina, y ejecutar este sitio web con el costo m√≠nimo, decid√≠ deshacerme de √©l y explore otras opciones (sin embargo, recomiendo dar vistazo al incre√≠ble trabajo que est√° haciendo el equipo detr√°s del producto, vale la pena).

Entonces, estaba all√≠, pregunt√°ndome qu√© opci√≥n deber√≠a usar, as√≠ que como prueba final antes de volver a Google Analytics, escrib√≠ [un rastreador de vistas de p√°gina personalizado usando rutas API y FaunaDB](https://github.com/arturocr/arturocampos.dev/commit/1d50543fb4fe8f0d34d17fdaf288d908980affe6). Fue un ejercicio realmente interesante, sin embargo, se estaba volviendo un poco complejo de manejar, especialmente cuando quer√≠a tener contadores de vistas de p√°gina reales y no solo un contador que aumentara cada vez que se accediera a una URL, incluso si era solo una actualizaci√≥n.

Es importante mencionar que todo este salto entre diferentes productos de rastreo definitivamente me hizo perder registros de visitas que ya ten√≠a ya que algunas estaban registradas en una de las plataformas y otras en las otras.

Entonces, despu√©s de todos esos intentos, termin√© volviendo a Google Analytics, sin embargo, esta vez hab√≠a un desaf√≠o en el plan, quer√≠a extraer las vistas de p√°gina de Google Analytics usando las API de Google.

---

<span id='solution' aria-hidden='true' />

## Registro de las visitas con Google Analytics

_Debo mencionar que este enfoque est√° muy inspirado en el paquete [next-ga](https://github.com/sergiodxa/next-ga) y en el [plugin experimental de Next.js](https://github.com/vercel/next.js/tree/canary/packages/next-plugin-google-analytics) para Google Analytics._

Comencemos agregando el c√≥digo necesario para realizar el seguimiento de visitas cuando alguien visita una p√°gina. Para hacer eso, existen algunas bibliotecas que ofrecen una "soluci√≥n simple", pero quer√≠a tener un control total sobre el c√≥digo.

Primero, creamos un peque√±o m√≥dulo en la ruta de su preferencia que b√°sicamente expondr√° tres cosas: el ID de seguimiento de Google Analytics, un m√©todo `pageview` y un m√©todo `event`. En mi caso, lo cre√© dentro de la carpeta lib en el nivel superior.

```javascript:lib/gtag.js
export const GA_TRACKING_ID = 'UA-XXXXXXXXX-X';

export const pageview = (url, title) => {
  window.gtag('config', GA_TRACKING_ID, {
    page_location: url,
    page_title: title,
  });
};

export const event = ({ action, category, label, value }) => {
  window.gtag('event', action, {
    event_category: category,
    event_label: label,
    value: value,
  });
};
```

En segundo lugar, modifiquemos el archivo `_document.js` dentro del directorio `pages` para incluir el fragmento de JavaScript de Google Analytics.

```javascript{10-19}:pages/_document.js
import Document, { Html, Head, Main, NextScript } from 'next/document';
import { GA_TRACKING_ID } from '@/lib/gtag';

class MyDocument extends Document {
  render() {
    return (
      <Html>
        <Head>
          ...
          {/* Global Site Tag (gtag.js) - Google Analytics */}
          <script
            async
            src={`https://www.googletagmanager.com/gtag/js?id=${GA_TRACKING_ID}`}
          />
          <script
            dangerouslySetInnerHTML={{
              __html: `
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', '${GA_TRACKING_ID}');
              `,
            }}
          />
          ...
        </Head>
        <body>
          <Main />
          <NextScript />
        </body>
      </Html>
    );
  }
}

export default MyDocument;
```

Esto inyecta de forma asincr√≥nica el fragmento que inicializa Google Analytics. Lo que ayuda a mantener un buen rendimiento, que es una de las preocupaciones m√°s comunes cuando se incluye Google Analytics en un sitio web.

En tercer lugar, necesitamos rastrear una vista de p√°gina cada vez que una ruta transicione, para lograr esto, podemos aprovechar el router de Next.js para ejecutar una funci√≥n callback cada vez que cambia la ruta, el evento `routeChangeComplete` es el que queremos utilizar en este caso. Actualicemos `_app.js` con el c√≥digo correspondiente:

```javascript{1-2,5-13}:pages/_app.js
import { useEffect } from 'react';
import { pageview } from '@/lib/gtag';

const MyApp = ({ Component, pageProps, router }) => {
  useEffect(() => {
    const handleRouteChange = url => {
      pageview(url, document.title);
    };
    router.events.on('routeChangeComplete', handleRouteChange);
    return () => {
      router.events.off('routeChangeComplete', handleRouteChange);
    };
  }, []);

  return (
    <Component {...pageProps} />
  );
};

export default MyApp;
```

Con solo esas pocas l√≠neas de c√≥digo, el sitio web rastrear√° las visitas a cada p√°gina de ahora en adelante, si notaron el m√©todo `event` en `lib/gtag.js`, es un m√©todo que puede usarse para rastrear eventos de usuario espec√≠ficos como el env√≠o de un formulario por ejemplo.

---

## Mostrar un contador de visitas con datos de Google Analytics

En este punto, el seguimiento de vistas est√° funcionando, as√≠ que estamos listos para agregar el contador de visitas a las p√°ginas de mi blog. Aprovechar√© las [rutas API](https://nextjs.org/docs/api-routes/introduction) de Next.js para esto.

Comencemos creando un nuevo archivo dentro del directorio `pages/api`:

```javascript:pages/api/page-views.js
export default async (req, res) => {
  const startDate = req.query.startDate || '2020-01-01';
  const slug = req.query.slug;

  try {
    res.status(200).json({
      pageViews: 0,
    });
  } catch (err) {
    return res.status(500).json({ error: err.message });
  }
}
```

Esta funci√≥n esperar√° dos par√°metros en el query string: `startDate` y `slug` que se utilizar√°n para filtrar los resultados.

Si abre la URL `http://localhost:3000/api/page-views` en su navegador, ver√° que responde con el JSON proporcionado.

<Image
  alt='Respuesta initial falsa del API'
  src='/images/blog/nextjs-with-google-analytics__api-route.png'
  layout='responsive'
  height='974'
  width='1224'
/>

Ahora, para conectarnos a la API de Google Analytics y obtener las visitas por p√°gina para una URL espec√≠fica, necesitamos instalar el cliente Node.js de las API de Google.

```shell
npm install googleapis --save
# o
yarn add googleapis
```

Antes de conectarnos a las API de Google, necesitamos obtener acceso, as√≠ que sigamos los siguientes pasos:

1. Ir al [Google Developer Console](https://console.developers.google.com/).
1. Crear un nuevo proyecto.
1. Ir a la secci√≥n Credentials, seleccionar "Create Credentials" y escoger "Service Account".
   - Navegar a los detalles del Service Account y expandir la secci√≥n "Show domain-wide delegation", marcar la opci√≥n "Enable G Suite Domain-wide Delegation".
   - Damos click en "Add Key" (m√°s abajo en esa misma p√°gina), escogemos JSON y damos click en "Create".
   - Guardamos el archivo JSON, lo necesitaremos luego.
   - Damos click en el bot√≥n "Save" al final de esa p√°gina.
1. Navegamos de regreso al inicio del proyecto y damos click en "+ Enable APIs and Services".
1. Buscamos "Google Analytics API" y lo habilitamos.
1. Ahora vamos al [dashboard de Google Analytics](https://analytics.google.com/).
1. Una vez seleccionada la cuenta de Analytics correcta, vamos al Admin panel.
1. Damos click en "View User Management".
1. Agregamos un nuevo usuario, el email es el que encontramos en el campo `client_email` del archivo JSON que guardamos antes.

OK, vamos a configurar las variables de ambiente con los secretos que acabamos de generar.

Creamos un archivo `.env.local` en la ra√≠z del proyecto.

```shell:.env.local
GOOGLE_ANALYTICS_VIEW_ID=123456789
GOOGLE_CLIENT_EMAIL=service-account@project.iam.gserviceaccount.com
GOOGLE_CLIENT_ID=1234567890
GOOGLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nR2D2=\n-----END PRIVATE KEY-----\n"
```

`GOOGLE_ANALYTICS_VIEW_ID` es el View ID que podemos encontrar en el Admin Panel de Google Analytics (arriba de "View User Management").

Los otros valores est√°n en el archivo JSON del paso #3:

- `GOOGLE_CLIENT_EMAIL` -> `client_email`
- `GOOGLE_CLIENT_ID` -> `client_id`
- `GOOGLE_PRIVATE_KEY` -> `private_key`

En este punto es posible acceder a esas variables de ambiente usando `process.env.GOOGLE_CLIENT_EMAIL`, por ejemplo, esto es posible gracias a la configuraci√≥n autom√°gica de [Variables de Ambiente](https://nextjs.org/docs/basic-features/environment-variables) de Next.js.

Ahora es momento de conectar la ruta API al API de Analytics.

Importamos el paquete `googleapis` y creamos los credenciales:

```javascript{1,8-15}:pages/api/page-views.js
import { google } from 'googleapis';

export default async (req, res) => {
  const startDate = req.query.startDate || '2020-01-01';
  const slug = req.query.slug;

  try {
    const auth = new google.auth.GoogleAuth({
      credentials: {
        client_email: process.env.GOOGLE_CLIENT_EMAIL,
        client_id: process.env.GOOGLE_CLIENT_ID,
        private_key: process.env.GOOGLE_PRIVATE_KEY,
      },
      scopes: ['https://www.googleapis.com/auth/analytics.readonly'],
    });

    res.status(200).json({
      pageViews: 0,
    });
  } catch (err) {
    return res.status(500).json({ error: err.message });
  }
}
```

Luego, instanciamos el cliente de Google Analytics v3 y hacemos la llamada para obtener las m√©tricas.

```javascript{9-27}:pages/api/page-views.js
import { google } from 'googleapis';

export default async (req, res) => {
  const startDate = req.query.startDate || '2020-01-01';
  const slug = req.query.slug;

  try {
    ...
    const analytics = google.analytics({
      auth,
      version: 'v3',
    });

    const response = await analytics.data.ga.get({
      'end-date': 'today',
      ids: `ga:${process.env.GOOGLE_ANALYTICS_VIEW_ID}`,
      metrics: 'ga:pageviews',
      dimensions: 'ga:pagePath',
      filters: `ga:pagePath==${slug}`,
      'start-date': startDate,
    });

    const pageViews = response?.data?.totalsForAllResults['ga:pageviews'];

    return res.status(200).json({
      pageViews,
    });
  } catch (err) {
    return res.status(500).json({ error: err.message });
  }
}
```

Algunas observaciones aqu√≠:

- El par√°metro `filters` restringe los resultados a una URL espec√≠fica.
- El par√°metro `startDate`, si no se provee, se setea a `2020-01-01` para obtener datos desde esa fecha (anterior al lanzamiento de mi blog).

Abrimos un URL como `http://localhost:3000/api/page-views?slug=/blog/hello-world`, en este caso estoy incluyendo un slug v√°lido y existente, lo que me da el siguiente resultado:

<Image
  alt='Respuesta de API con valores reales'
  src='/images/blog/nextjs-with-google-analytics__api-route-response.png'
  layout='responsive'
  height='974'
  width='1486'
/>

¬°Genial!

Ahora es momento de conectar la p√°gina de blog con el API y mostrar el contador de visitas. Me gusta mucho la simplicidad que [SWR](https://swr.vercel.app/) provee cuando se trabaja con hooks y APIs, puede instalarlo o su usar su propio m√©todo.

```shell
npm install swr --save
# o
yarn add swr
```

Mi p√°gina de art√≠culo de blog vive en `pages/blog/[slug].js`, estos son los cambios requeridos para mostrar el contador de visitas:

```javascript{2,6-14,19}:pages/blog/[slug].js
...
import useSWR from 'swr';

export default ({ mdxSource, frontMatter }) => {
  ...
  const { data } = useSWR(
    `/api/page-views?slug=${encodeURIComponent(localizedSlug)}`,
    async url => {
      const res = await fetch(url);
      return res.json();
    },
    { revalidateOnFocus: false }
  );
  const views = data?.pageViews || 0;

  return (
    <>
      ...
      <div>{views} vistas</div>
      ...
    </>
  );
}
```

Y, ¬°eso es todo! üéâ

<Image
  alt='Resultado final mostrando el contador de visitas'
  src='/images/blog/nextjs-with-google-analytics__final-result[es].png'
  layout='responsive'
  height='292'
  width='1574'
/>

Como la llamada al API ocurre del lado del cliente, cada vez que se ingrese a un art√≠culo del blog, se mostrar√° informaci√≥n fresca de las visitas a esa p√°gina, informaci√≥n tra√≠da directamente del API de Google Analytics.

Sinceramente espero que hayan disfrutado este art√≠culo, por favor no duden en compartirlo. üòÅ

Gracias por leerme, y hasta el pr√≥ximo post. ‚ö°Ô∏è
